<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ArtBeat Studio — خلاط إيقاعات مبدع</title>
<style>
  :root{
    --bg:#0b0f17;--panel:#0f1522;--line:#1b2537;--fg:#e7eef7;--mut:#9bb0c7;--acc:#00d0ff;--hot:#ff5e8a;
  }
  html,body{height:100%}
  body{margin:0;background:linear-gradient(180deg,#0b0f17,#0a0d14);color:var(--fg);font-family:system-ui,Segoe UI,Arial}
  header{display:flex;gap:10px;align-items:center;padding:12px 14px;border-bottom:1px solid var(--line);flex-wrap:wrap}
  header h1{font-size:16px;margin:0;color:#c9ecff}
  button,select,input[type=range]{accent-color:var(--acc)}
  button{background:#131a29;color:var(--fg);border:1px solid var(--line);border-radius:10px;padding:8px 12px;cursor:pointer}
  button:active{transform:translateY(1px)}
  .wrap{display:grid;grid-template-columns:320px 1fr;gap:12px;padding:12px}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:12px}
  .card h2{margin:0 0 8px 0;font-size:14px;color:#9bd3ff}
  .row{display:flex;align-items:center;gap:8px;margin:8px 0}
  .row label{min-width:110px;color:#cfe5ff;font-size:13px}
  .row output{min-width:56px;text-align:end;color:#8fb3c9}
  .grid{display:grid;grid-template-columns:repeat(16,1fr);gap:6px}
  .trk{display:grid;grid-template-columns:90px 1fr;gap:8px;align-items:center;margin:6px 0}
  .trk .name{font-size:12px;color:#d5e9ff}
  .step{height:26px;border-radius:6px;border:1px solid var(--line);background:#0c111b;cursor:pointer}
  .step.on{background:linear-gradient(180deg,#10243d,#0e1b2e);border-color:#28506d;box-shadow:inset 0 0 0 2px #1b3b52}
  .step.on.hot{background:linear-gradient(180deg,#1c2d4a,#112a41);box-shadow:0 0 0 1px var(--hot) inset}
  .step.play{outline:2px solid var(--acc)}
  .mixer{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
  .ch{background:#0c131f;border:1px solid var(--line);border-radius:10px;padding:8px}
  .ch h3{margin:0 0 6px 0;font-size:12px;color:#a8d7ff}
  .sl{display:flex;gap:6px;align-items:center}
  .sl input[type=range]{width:100%}
  .mutebtn{font-size:12px}
  canvas{width:100%;height:140px;background:#0a0f19;border-radius:10px;border:1px solid var(--line)}
  #pad{height:200px;cursor:crosshair;touch-action:none;background:linear-gradient(180deg,#0b1626,#0a0e16)}
  .hint{color:var(--mut);font-size:12px;margin-top:6px;line-height:1.5}
  .badges{display:flex;gap:8px;flex-wrap:wrap}
  .badge{background:#0e1626;border:1px solid var(--line);padding:4px 8px;border-radius:999px;font-size:11px;color:#b4c7de}
  footer{padding:10px 14px;border-top:1px solid var(--line);color:#86a3c0;font-size:12px}
  @media (max-width:1000px){.wrap{grid-template-columns:1fr}}
</style>
</head>
<body>
<header>
  <h1>🎼 ArtBeat Studio — صانع إيقاعات بخلاط وواجهة ذكية</h1>
  <button id="start">تشغيل الصوت</button>
  <button id="playStop">تشغيل</button>
  <button id="rec">تسجيل</button>
  <button id="mixToggle">الخلاط</button>
  <select id="kit">
    <option value="electro" selected>مجموعة: إلكتروني</option>
    <option value="tabla">مجموعة: طبلة/إيقاع عربي</option>
    <option value="choir">مجموعة: كورال/نغمي</option>
  </select>
  <select id="patternSel">
    <option value="init">نمط: INIT</option>
    <option value="house">House 120</option>
    <option value="trap">Trap 140</option>
    <option value="dembow">Dembow</option>
    <option value="khaleeji">خليجي</option>
    <option value="ambient">Ambient Pad</option>
  </select>
  <button id="savePat">حفظ</button>
  <button id="loadPat">تحميل</button>
  <span class="hint">لوحة الأداء: X=Tempo/Swing • Y=Cutoff/Reverb • عجلة الماوس=Accent</span>
</header>

<div class="wrap">
  <div class="card">
    <h2>🎯 لوحة الأداء بالماوس/التاتش</h2>
    <canvas id="pad"></canvas>
    <div class="badges">
      <span class="badge">Tempo</span><span class="badge">Swing</span><span class="badge">Master Filter</span><span class="badge">Reverb</span>
    </div>
    <div class="row"><label>Tempo</label><input id="tempo" type="range" min="60" max="180" step="1" value="120"><output>120</output></div>
    <div class="row"><label>Swing %</label><input id="swing" type="range" min="0" max="70" step="1" value="0"><output>0</output></div>
    <div class="row"><label>Reverb</label><input id="revWet" type="range" min="0" max="1" step="0.01" value="0.2"><output>0.20</output></div>
    <div class="row"><label>Master Cutoff</label><input id="masterCutoff" type="range" min="200" max="12000" step="1" value="8000"><output>8000</output></div>
    <div class="row"><label>Accent (٪)</label><input id="accentAmt" type="range" min="0" max="1" step="0.01" value="0.25"><output>0.25</output></div>
    <div class="hint">انقر على المربعات لتفعيل/إلغاء خطوات الإيقاع. النقر بالزر الأيمن = لهجة (Accent). Shift+نقر = Hot.</div>
    <h2>📈 فيجوالايزر</h2>
    <canvas id="scope"></canvas>
  </div>

  <div class="card" id="seqCard">
    <h2>🧩 مسلسِل الخطوات (16 خطوة × 8 مسارات)</h2>
    <div id="tracks"></div>
  </div>

  <div class="card" id="mixerCard" style="display:none">
    <h2>🎚️ الخلاط</h2>
    <div class="mixer" id="mixer"></div>
  </div>
</div>

<footer>© ArtBeat Studio — اصنع مقطوعات فريدة. احفظ/حمّل الأنماط، سجّل الأداء، وادمج الطبلة والكورال.</footer>

<script>
(() => {
  const $ = id => document.getElementById(id);
  const outSync = el => { const o = el.nextElementSibling; const f=()=>o.textContent = el.value; el.addEventListener('input',f); f(); };

  // === Audio Core ===
  let actx, master, analyser, meter, comp;
  let masterFilter, rev, revDelay1, revDelay2, revFB1, revFB2, revWet, revDry;
  let destNode;
  let mediaDest, mediaRecorder, recChunks = [];

  const NUM_STEPS = 16;
  const TRACKS_DEF = [
    {id:'kick',  name:'Kick',  color:'#ff8b5e'},
    {id:'snare', name:'Snare/Clap', color:'#ff5e8a'},
    {id:'hat',   name:'Hi-Hat', color:'#ffd15e'},
    {id:'perc',  name:'Perc',  color:'#9bff5e'},
    {id:'tabla', name:'Tabla', color:'#5effe1'},
    {id:'bass',  name:'Bass', color:'#5ea6ff'},
    {id:'chord', name:'Chord', color:'#bd85ff'},
    {id:'choir', name:'Choir', color:'#c1ffe3'},
  ];

  let kit = 'electro';
  let tempo = 120, swing = 0;
  let accentAmt = 0.25;

  // pattern: per track -> array of steps: {on, accent, hot, note(optional)}
  let pattern = {};
  function makeEmptyPattern(){
    const p = {};
    for (const t of TRACKS_DEF) p[t.id] = Array.from({length:NUM_STEPS},()=>({on:false,accent:false,hot:false}));
    return p;
  }

  // === Synths / Samplers (procedural) ===
  function initAudio(){
    if (actx) return;
    actx = new (window.AudioContext||window.webkitAudioContext)();
    master = actx.createGain(); master.gain.value = 0.8;
    masterFilter = actx.createBiquadFilter(); masterFilter.type='lowpass'; masterFilter.frequency.value = parseFloat($('masterCutoff').value);

    // simple reverb (Schroeder-like)
    revDelay1 = actx.createDelay(1); revDelay1.delayTime.value = 0.031;
    revDelay2 = actx.createDelay(1); revDelay2.delayTime.value = 0.013;
    revFB1 = actx.createGain(); revFB1.gain.value = 0.7;
    revFB2 = actx.createGain(); revFB2.gain.value = 0.7;
    revWet = actx.createGain(); revWet.gain.value = parseFloat($('revWet').value);
    revDry = actx.createGain(); revDry.gain.value = 1;

    revDelay1.connect(revFB1).connect(revDelay1);
    revDelay2.connect(revFB2).connect(revDelay2);

    // Mix reverb network
    const revIn = actx.createGain();
    revIn.connect(revDelay1); revIn.connect(revDelay2);
    const revMix = actx.createGain(); revDelay1.connect(revMix); revDelay2.connect(revMix);
    revMix.connect(revWet);

    // Dynamics
    comp = actx.createDynamicsCompressor();
    comp.threshold.value = -16;
    comp.knee.value = 16;
    comp.ratio.value = 3;
    comp.attack.value = 0.003;
    comp.release.value = 0.25;

    analyser = actx.createAnalyser(); analyser.fftSize = 2048;

    // Master routing
    const preMaster = actx.createGain(); preMaster.gain.value = 1;
    // Wet/dry join
    preMaster.connect(revIn);
    preMaster.connect(revDry);
    const join = actx.createGain();
    revWet.connect(join); revDry.connect(join);

    join.connect(masterFilter).connect(master).connect(comp).connect(analyser);

    // Destination + MediaRecorder stream
    if (actx.createMediaStreamDestination){
      mediaDest = actx.createMediaStreamDestination();
      analyser.connect(mediaDest);
    }
    destNode = actx.destination;
    analyser.connect(destNode);

    // expose send function for channels
    audioBus = {pre:preMaster, revIn, join};
  }

  let audioBus = null;

  // channel strip
  class Channel {
    constructor(name, color){
      this.name = name; this.color=color;
      this.vol = actx.createGain(); this.vol.gain.value = 0.8;
      this.pan = actx.createStereoPanner ? actx.createStereoPanner() : { pan:{ value:0 }, connect:(n)=>this.vol.connect(n)};
      this.mute = false;
      this.send = actx.createGain(); this.send.gain.value = 0.5; // to reverb
      this.chain = actx.createGain();
      this.chain.connect(this.vol);
      // route
      this.vol.connect(this.pan);
      if (this.pan.connect) this.pan.connect(audioBus.pre);
      this.send.connect(audioBus.revIn);
      this.hp = actx.createBiquadFilter(); this.hp.type='highpass'; this.hp.frequency.value=30;
      this.hp.connect(this.chain);
    }
  }

  const channels = {}; // per track
  function initChannels(){
    TRACKS_DEF.forEach(t => { channels[t.id] = new Channel(t.name, t.color); });
  }

  // === Sound generators ===
  function trigKick(ch, vel=1){
    const t = actx.currentTime;
    // Pitch sweep sine + click
    const osc = actx.createOscillator(); osc.type='sine';
    const g = actx.createGain(); g.gain.value=0;
    const dt = actx.createGain(); dt.gain.value=0;
    osc.connect(dt); dt.connect(g); g.connect(ch.hp);
    const startF = 150; const endF = 45;
    osc.frequency.setValueAtTime(startF, t);
    osc.frequency.exponentialRampToValueAtTime(endF, t+0.12);
    g.gain.setValueAtTime(0.0001, t);
    g.gain.exponentialRampToValueAtTime(1.0*vel, t+0.002);
    g.gain.exponentialRampToValueAtTime(0.0001, t+0.5);
    osc.start(t); osc.stop(t+0.6);
  }
  function trigSnare(ch, vel=1){
    const t = actx.currentTime;
    const nSrc = actx.createBufferSource();
    const bf = actx.createBuffer(1, actx.sampleRate*0.5, actx.sampleRate);
    const data = bf.getChannelData(0);
    for (let i=0;i<data.length;i++){ data[i]=(Math.random()*2-1)*Math.pow(1-i/data.length, 3); }
    nSrc.buffer = bf;
    const g = actx.createGain(); g.gain.value=0;
    nSrc.connect(g).connect(ch.hp);
    g.gain.setValueAtTime(0.001, t);
    g.gain.exponentialRampToValueAtTime(0.9*vel, t+0.003);
    g.gain.exponentialRampToValueAtTime(0.001, t+0.25);
    nSrc.start(t); nSrc.stop(t+0.26);
  }
  function trigHat(ch, vel=1){
    const t = actx.currentTime;
    // metallic via bandpass noise
    const nSrc = actx.createBufferSource();
    const bf = actx.createBuffer(1, actx.sampleRate*0.1, actx.sampleRate);
    const data = bf.getChannelData(0);
    for (let i=0;i<data.length;i++){ data[i]=(Math.random()*2-1); }
    nSrc.buffer = bf;
    const bp = actx.createBiquadFilter(); bp.type='bandpass'; bp.frequency.value=8000; bp.Q.value=6;
    const g = actx.createGain(); g.gain.value=0;
    nSrc.connect(bp).connect(g).connect(ch.hp);
    g.gain.setValueAtTime(0.001, t);
    g.gain.exponentialRampToValueAtTime(0.6*vel, t+0.002);
    g.gain.exponentialRampToValueAtTime(0.001, t+0.08);
    nSrc.start(t); nSrc.stop(t+0.09);
  }
  function trigPerc(ch, vel=1){
    const t = actx.currentTime;
    const osc = actx.createOscillator(); osc.type='square';
    const g = actx.createGain(); g.gain.value=0;
    const f = 550; osc.frequency.value=f;
    osc.connect(g).connect(ch.hp);
    g.gain.setValueAtTime(0.001, t);
    g.gain.exponentialRampToValueAtTime(0.6*vel, t+0.003);
    g.gain.exponentialRampToValueAtTime(0.001, t+0.12);
    osc.start(t); osc.stop(t+0.13);
  }
  function trigTabla(ch, vel=1, tone=180){
    const t = actx.currentTime;
    const osc = actx.createOscillator(); osc.type='sine';
    const g = actx.createGain(); g.gain.value=0;
    osc.connect(g).connect(ch.hp);
    osc.frequency.setValueAtTime(tone, t);
    osc.frequency.exponentialRampToValueAtTime(tone*0.6, t+0.12);
    g.gain.setValueAtTime(0.001, t);
    g.gain.exponentialRampToValueAtTime(0.9*vel, t+0.002);
    g.gain.exponentialRampToValueAtTime(0.001, t+0.22);
    osc.start(t); osc.stop(t+0.24);
  }
  function trigBass(ch, vel=1, note=55){
    const t = actx.currentTime;
    const o1=actx.createOscillator(); o1.type='sawtooth';
    const o2=actx.createOscillator(); o2.type='square';
    const m=actx.createGain(); m.gain.value=0.6;
    const g=actx.createGain(); g.gain.value=0;
    o1.frequency.value=note; o2.frequency.value=note;
    o1.connect(m); o2.connect(m); m.connect(g).connect(ch.hp);
    g.gain.setValueAtTime(0.001,t);
    g.gain.linearRampToValueAtTime(0.8*vel, t+0.01);
    g.gain.exponentialRampToValueAtTime(0.001, t+0.4);
    o1.start(t); o2.start(t); o1.stop(t+0.5); o2.stop(t+0.5);
  }
  function trigChord(ch, vel=1, root=220){
    const t = actx.currentTime;
    const freqs=[root, root*5/4, root*3/2];
    const g=actx.createGain(); g.gain.value=0;
    freqs.forEach(f=>{
      const o=actx.createOscillator(); o.type='triangle'; o.frequency.value=f;
      o.connect(g); o.start(t); o.stop(t+0.8);
    });
    const f = actx.createBiquadFilter(); f.type='lowpass'; f.frequency.value=1500; f.Q.value=0.7;
    g.connect(f).connect(ch.hp);
    g.gain.setValueAtTime(0.001, t);
    g.gain.linearRampToValueAtTime(0.7*vel, t+0.03);
    g.gain.exponentialRampToValueAtTime(0.001, t+0.9);
  }
  function trigChoir(ch, vel=1, note=440){
    const t = actx.currentTime;
    const o=actx.createOscillator(); o.type='sine';
    const g=actx.createGain(); g.gain.value=0;
    const form1 = actx.createBiquadFilter(); form1.type='bandpass'; form1.frequency.value=500; form1.Q.value=1.2;
    const form2 = actx.createBiquadFilter(); form2.type='bandpass'; form2.frequency.value=1200; form2.Q.value=1.5;
    o.frequency.value=note;
    o.connect(form1).connect(form2).connect(g).connect(ch.hp);
    g.gain.setValueAtTime(0.001,t);
    g.gain.linearRampToValueAtTime(0.5*vel, t+0.05);
    g.gain.exponentialRampToValueAtTime(0.001, t+1.2);
    o.start(t); o.stop(t+1.25);
  }

  function hit(trackId, step){
    const ch = channels[trackId];
    const st = pattern[trackId][step];
    const vel = st.accent ? (1+accentAmt) : 1;
    const hot = st.hot ? 1.15 : 1;
    const v = Math.min(1, vel*hot);
    switch(trackId){
      case 'kick': trigKick(ch, v); break;
      case 'snare': trigSnare(ch, v); break;
      case 'hat': trigHat(ch, v); break;
      case 'perc': trigPerc(ch, v); break;
      case 'tabla': trigTabla(ch, v, 190); break;
      case 'bass': trigBass(ch, v, 55); break;
      case 'chord': trigChord(ch, v, 220); break;
      case 'choir': trigChoir(ch, v, 440); break;
    }
    // send to reverb proportionally to v
    ch.send.gain.setTargetAtTime(0.4*v, actx.currentTime, 0.01);
  }

  // === Sequencer ===
  let playing = false, curStep = 0, timer = null;
  function stepTimeMs(){
    const spb = 60/tempo; // seconds per beat (quarter)
    return spb/4*1000; // 16th
  }
  function schedule(){
    const t = stepTimeMs();
    const swingOffset = (curStep%2===1) ? (swing/100)*t*0.5 : 0;
    timer = setTimeout(tick, t + swingOffset);
  }
  function tick(){
    const step = curStep;
    // play enabled steps
    for (const trk of TRACKS_DEF){
      if (pattern[trk.id][step].on && !channels[trk.id].mute){
        hit(trk.id, step);
      }
      const el = document.querySelector(`.step[data-track="${trk.id}"][data-step="${step}"]`);
      if (el){ el.classList.add('play'); setTimeout(()=>el.classList.remove('play'), stepTimeMs()*0.8); }
    }
    curStep = (curStep+1)%NUM_STEPS;
    schedule();
  }

  function start(){
    if (!actx) initAudio();
    if (playing) return;
    actx.resume();
    playing = true;
    curStep = 0;
    schedule();
  }
  function stop(){
    playing = false;
    clearTimeout(timer);
  }

  // === UI Build ===
  function buildSequencer(){
    const wrap = $('tracks');
    wrap.innerHTML = '';
    TRACKS_DEF.forEach(trk => {
      const row = document.createElement('div'); row.className='trk';
      const name = document.createElement('div'); name.className='name'; name.textContent=trk.name;
      row.appendChild(name);
      const grid = document.createElement('div'); grid.className='grid';
      for (let i=0;i<NUM_STEPS;i++){
        const s = document.createElement('div');
        s.className='step';
        s.dataset.track=trk.id; s.dataset.step=i;
        s.title = `${trk.name} @ ${i+1}`;
        s.addEventListener('click', e => {
          const st = pattern[trk.id][i];
          st.on = !st.on;
          s.classList.toggle('on', st.on);
        });
        s.addEventListener('contextmenu', e => {
          e.preventDefault();
          const st = pattern[trk.id][i];
          st.accent = !st.accent;
          s.classList.toggle('hot', st.accent);
        });
        s.addEventListener('mousedown', e => {
          if (e.shiftKey){
            const st = pattern[trk.id][i];
            st.hot = !st.hot;
            s.classList.toggle('hot', st.hot);
          }
        });
        grid.appendChild(s);
      }
      row.appendChild(grid);
      wrap.appendChild(row);
    });
  }

  function buildMixer(){
    const mix = $('mixer'); mix.innerHTML='';
    TRACKS_DEF.forEach(trk => {
      const ch = document.createElement('div'); ch.className='ch';
      const h = document.createElement('h3'); h.textContent=trk.name; ch.appendChild(h);
      const volRow = document.createElement('div'); volRow.className='sl';
      const vol = document.createElement('input'); vol.type='range'; vol.min=0; vol.max=1; vol.step=0.01; vol.value=0.8;
      const vo = document.createElement('output'); vo.textContent='0.80';
      vol.addEventListener('input', ()=>{ channels[trk.id].vol.gain.value=parseFloat(vol.value); vo.textContent=vol.value; });
      volRow.appendChild(document.createTextNode('Vol')); volRow.appendChild(vol); volRow.appendChild(vo);
      const panRow = document.createElement('div'); panRow.className='sl';
      const pan = document.createElement('input'); pan.type='range'; pan.min=-1; pan.max=1; pan.step=0.01; pan.value=0;
      const pao = document.createElement('output'); pao.textContent='0.00';
      pan.addEventListener('input', ()=>{ if(channels[trk.id].pan.pan) channels[trk.id].pan.pan.value=parseFloat(pan.value); pao.textContent=pan.value; });
      panRow.appendChild(document.createTextNode('Pan')); panRow.appendChild(pan); panRow.appendChild(pao);
      const sendRow = document.createElement('div'); sendRow.className='sl';
      const send = document.createElement('input'); send.type='range'; send.min=0; send.max=1; send.step=0.01; send.value=0.4;
      const sdo = document.createElement('output'); sdo.textContent='0.40';
      send.addEventListener('input', ()=>{ channels[trk.id].send.gain.value=parseFloat(send.value); sdo.textContent=send.value; });
      sendRow.appendChild(document.createTextNode('Reverb')); sendRow.appendChild(send); sendRow.appendChild(sdo);
      const btn = document.createElement('button'); btn.className='mutebtn'; btn.textContent='Mute'; btn.addEventListener('click', ()=>{ channels[trk.id].mute=!channels[trk.id].mute; btn.textContent = channels[trk.id].mute?'Unmute':'Mute'; });
      ch.appendChild(volRow); ch.appendChild(panRow); ch.appendChild(sendRow); ch.appendChild(btn);
      mix.appendChild(ch);
    });
  }

  // === Preset patterns ===
  function loadPreset(name){
    pattern = makeEmptyPattern();
    if (name==='house'){
      tempo=120; $('tempo').value=tempo; $('tempo').dispatchEvent(new Event('input'));
      // Kick 1,5,9,13 ; Snare 5,13 ; Hats on 8ths
      [0,4,8,12].forEach(i => pattern.kick[i].on=true);
      [4,12].forEach(i => pattern.snare[i].on=true);
      for (let i=0;i<NUM_STEPS;i+=2){ pattern.hat[i].on=true; if (i%4===2) pattern.hat[i].accent=true; }
      pattern.perc[10].on=true; pattern.perc[14].on=true;
      pattern.bass[0].on=true; pattern.bass[8].on=true;
      pattern.chord[0].on=true; pattern.chord[8].on=true;
    } else if (name==='trap'){
      tempo=140; $('tempo').value=tempo; $('tempo').dispatchEvent(new Event('input'));
      [0,8].forEach(i=>pattern.kick[i].on=true); [4,12].forEach(i=>pattern.snare[i].on=true);
      for (let i=0;i<NUM_STEPS;i++){ if (i%2===0) pattern.hat[i].on=true; if (i%4===3) pattern.hat[i].accent=true; }
      [2,6,10,14].forEach(i=>pattern.perc[i].on=true);
      [0,4,8,12].forEach(i=>pattern.bass[i].on=true);
    } else if (name==='dembow'){
      tempo=96; $('tempo').value=tempo; $('tempo').dispatchEvent(new Event('input'));
      [0,7,8,11].forEach(i=>pattern.kick[i].on=true);
      [4,12].forEach(i=>pattern.snare[i].on=true);
      for (let i=0;i<NUM_STEPS;i+=1){ if (i%2===0) pattern.hat[i].on=true; }
      [3,10,15].forEach(i=>pattern.perc[i].on=true);
    } else if (name==='khaleeji'){
      tempo=106; $('tempo').value=tempo; $('tempo').dispatchEvent(new Event('input'));
      [0,4,8,12].forEach(i=>pattern.tabla[i].on=true);
      [6,14].forEach(i=>{ pattern.tabla[i].on=true; pattern.tabla[i].accent=true; });
      [4,12].forEach(i=>pattern.snare[i].on=true);
      for (let i=0;i<NUM_STEPS;i+=2){ pattern.hat[i].on=true; }
      [2,10].forEach(i=>pattern.perc[i].on=true);
      [0,8].forEach(i=>pattern.chord[i].on=true);
    } else if (name==='ambient'){
      tempo=80; $('tempo').value=tempo; $('tempo').dispatchEvent(new Event('input'));
      [0,8].forEach(i=>pattern.chord[i].on=true);
      [4,12].forEach(i=>pattern.choir[i].on=true);
      for (let i=0;i<NUM_STEPS;i+=2) pattern.hat[i].on=true;
      [0,8].forEach(i=>pattern.kick[i].on=true);
    }
    refreshUIFromPattern();
  }

  function refreshUIFromPattern(){
    document.querySelectorAll('.step').forEach(el=>{
      const trk = el.dataset.track, st = parseInt(el.dataset.step,10);
      const p = pattern[trk][st];
      el.classList.toggle('on', !!p.on);
      el.classList.toggle('hot', !!(p.accent || p.hot));
    });
  }

  // === Save/Load ===
  function exportPattern(){
    const obj = {tempo, swing, accentAmt, kit, pattern};
    const data = new Blob([JSON.stringify(obj)], {type:'application/json'});
    const url = URL.createObjectURL(data);
    const a = document.createElement('a'); a.href=url; a.download='artbeat_pattern.json'; a.click();
    setTimeout(()=>URL.revokeObjectURL(url), 1000);
  }
  function importPattern(){
    const inp = document.createElement('input'); inp.type='file'; inp.accept='application/json';
    inp.onchange = () => {
      const f = inp.files[0]; if (!f) return;
      const r = new FileReader();
      r.onload = () => {
        const obj = JSON.parse(r.result);
        tempo = obj.tempo||tempo; $('tempo').value=tempo; $('tempo').dispatchEvent(new Event('input'));
        swing = obj.swing||swing; $('swing').value=swing; $('swing').dispatchEvent(new Event('input'));
        accentAmt = obj.accentAmt ?? accentAmt; $('accentAmt').value=accentAmt; $('accentAmt').dispatchEvent(new Event('input'));
        kit = obj.kit||kit; $('kit').value=kit;
        pattern = obj.pattern||pattern;
        refreshUIFromPattern();
      };
      r.readAsText(f);
    };
    inp.click();
  }

  // === Recording ===
  function startRec(){
    if (!mediaDest){ alert('التسجيل غير مدعوم في هذا المتصفح'); return; }
    recChunks = [];
    mediaRecorder = new MediaRecorder(mediaDest.stream);
    mediaRecorder.ondataavailable = e => { if (e.data.size>0) recChunks.push(e.data); };
    mediaRecorder.onstop = () => {
      const blob = new Blob(recChunks, {type:'audio/webm'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='artbeat_recording.webm'; a.click();
      setTimeout(()=>URL.revokeObjectURL(url), 2000);
    };
    mediaRecorder.start();
    $('rec').textContent = 'إيقاف التسجيل';
  }
  function stopRec(){
    if (mediaRecorder && mediaRecorder.state!=='inactive'){
      mediaRecorder.stop();
      $('rec').textContent = 'تسجيل';
    }
  }

  // === Pad mapping ===
  function padPosToTempo(x,w){ const t = Math.max(0,Math.min(1,x/w)); return 60 + t*(180-60); }
  function padPosToCutoff(y,h){ const t = 1 - Math.max(0,Math.min(1,y/h)); return 200 * Math.pow(12000/200, t); }
  function padPosToSwing(x,w){ const t = Math.max(0,Math.min(1,x/w)); return t*70; }
  function padPosToReverb(y,h){ const t = 1 - Math.max(0,Math.min(1,y/h)); return t; }

  function bindPad(){
    const pad = $('pad');
    function draw(x,y){
      const c = pad.getContext('2d'), w = pad.width = pad.clientWidth, h = pad.height = pad.clientHeight;
      c.clearRect(0,0,w,h);
      const grad = c.createLinearGradient(0,0,w,h);
      grad.addColorStop(0,'#0b1f38'); grad.addColorStop(1,'#0a0e16');
      c.fillStyle = grad; c.fillRect(0,0,w,h);
      if (typeof x==='number' && typeof y==='number'){
        c.strokeStyle = '#00d0ff'; c.lineWidth=1;
        c.beginPath(); c.moveTo(x,0); c.lineTo(x,h); c.moveTo(0,y); c.lineTo(w,y); c.stroke();
        c.fillStyle='#00d0ff'; c.beginPath(); c.arc(x,y,6,0,Math.PI*2); c.fill();
      }
      c.fillStyle='#9aa4ad'; c.font='12px system-ui';
      c.fillText('Tempo/Swing →', 10, 18);
      c.fillText('Reverb/Cutoff ↓', 10, 34);
    }
    draw();
    let down=false;
    function update(e){
      const r = pad.getBoundingClientRect();
      const x = (e.touches? e.touches[0].clientX : e.clientX) - r.left;
      const y = (e.touches? e.touches[0].clientY : e.clientY) - r.top;
      tempo = Math.round(padPosToTempo(x, r.width));
      swing = Math.round(padPosToSwing(x, r.width));
      const cutoff = padPosToCutoff(y, r.height);
      const rv = padPosToReverb(y, r.height);
      $('tempo').value=tempo; $('tempo').dispatchEvent(new Event('input'));
      $('swing').value=swing; $('swing').dispatchEvent(new Event('input'));
      $('masterCutoff').value=Math.round(cutoff); $('masterCutoff').dispatchEvent(new Event('input'));
      $('revWet').value=rv.toFixed(2); $('revWet').dispatchEvent(new Event('input'));
      draw(x,y);
    }
    pad.addEventListener('mousedown', e=>{ down=true; update(e); });
    pad.addEventListener('mousemove', e=>{ if(down) update(e); });
    pad.addEventListener('mouseup', ()=>{ down=false; });
    pad.addEventListener('mouseleave', ()=>{ down=false; });
    pad.addEventListener('touchstart', e=>{ down=true; update(e); }, {passive:true});
    pad.addEventListener('touchmove', e=>{ update(e); }, {passive:true});
    pad.addEventListener('touchend', ()=>{ down=false; }, {passive:true});
    pad.addEventListener('wheel', e=>{
      e.preventDefault();
      const d = e.deltaY<0 ? 0.02 : -0.02;
      accentAmt = Math.max(0, Math.min(1, accentAmt + d));
      $('accentAmt').value = accentAmt.toFixed(2);
      $('accentAmt').dispatchEvent(new Event('input'));
    }, {passive:false});
  }

  // === Visualizer ===
  function scopeLoop(){
    const cvs = $('scope'), w=cvs.width=cvs.clientWidth, h=cvs.height=cvs.clientHeight;
    const g=cvs.getContext('2d'); g.fillStyle='#060a12'; g.fillRect(0,0,w,h);
    if (!analyser) return requestAnimationFrame(scopeLoop);
    const data = new Uint8Array(analyser.fftSize);
    analyser.getByteTimeDomainData(data);
    g.strokeStyle='#8fe1ff'; g.lineWidth=1.2; g.beginPath();
    for(let i=0;i<data.length;i++){ const x=i/data.length*w; const y=(data[i]/255)*h; if(i===0) g.moveTo(x,y); else g.lineTo(x,y); }
    g.stroke();
    requestAnimationFrame(scopeLoop);
  }

  // === DOM binds ===
  ['tempo','swing','revWet','masterCutoff','accentAmt'].forEach(id=>outSync($(id)));

  $('start').addEventListener('click', ()=>{ initAudio(); actx.resume(); });
  $('playStop').addEventListener('click', ()=>{ if (playing){ stop(); $('playStop').textContent='تشغيل'; } else { start(); $('playStop').textContent='إيقاف'; } });
  $('rec').addEventListener('click', ()=>{ if (!mediaRecorder || mediaRecorder.state==='inactive') startRec(); else stopRec(); });
  $('mixToggle').addEventListener('click', ()=>{
    const mc = $('mixerCard'); mc.style.display = mc.style.display==='none' ? 'block' : 'none';
  });

  $('kit').addEventListener('change', e=>{
    kit = e.target.value;
    // Could switch synthesis parameters per kit later
  });
  $('patternSel').addEventListener('change', e=>loadPreset(e.target.value));
  $('savePat').addEventListener('click', exportPattern);
  $('loadPat').addEventListener('click', importPattern);

  $('tempo').addEventListener('input', e=>{ tempo = parseFloat(e.target.value); });
  $('swing').addEventListener('input', e=>{ swing = parseFloat(e.target.value); });
  $('revWet').addEventListener('input', e=>{ if(revWet) revWet.gain.value=parseFloat(e.target.value); });
  $('masterCutoff').addEventListener('input', e=>{ if(masterFilter) masterFilter.frequency.setTargetAtTime(parseFloat(e.target.value), actx.currentTime, 0.02); });
  $('accentAmt').addEventListener('input', e=>{ accentAmt=parseFloat(e.target.value); });

  // Build
  pattern = makeEmptyPattern();
  buildSequencer();
  bindPad();
  scopeLoop();
  // Mixer after audio ready
  $('start').addEventListener('click', ()=>{ initChannels(); buildMixer(); });

  // Keyboard shortcuts
  window.addEventListener('keydown', e=>{
    if (e.code==='Space'){ e.preventDefault(); $('playStop').click(); }
    if (e.key==='m'){ $('mixToggle').click(); }
    if (/^[1-6]$/.test(e.key)){ const map={1:'init',2:'house',3:'trap',4:'dembow',5:'khaleeji',6:'ambient'}; $('patternSel').value=map[e.key]; loadPreset(map[e.key]); }
  });

  // default pattern
  loadPreset('house');
})();
</script>
</body>
</html>
